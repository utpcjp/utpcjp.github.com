<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">

<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>Problem L: チクチクバンバン</title>
    <style type="text/css">
      <!--
      h1 {
        text-align: center;
      }

      .timelimit {
        font-weight: bold;
	text-align: right;
      }

      .figure {
        text-align: center;
      }

      .figure table {
        margin-left: auto;
	margin-right: auto;
      }

      pre.sampleinput, pre.sampleoutput {
	padding: 0.5em;
        border: solid thin black;
      }

      .illust {
        margin-left: 3em;
	margin-right: 3em;
      }
      -->
    </style>
  </head>
  <h1>Problem L: チクチクバンバン</h1>
  <p class="timelimit">Time Limit: 5 sec</p>

  <p>
    屋根裏を整理していると，子供の時によく遊んだおもちゃが見つかった．
    このおもちゃはチクチクバンバンという名前で，
    サボテンを載せた貨物列車をレールから脱線しないように
    駅から駅まで運ぶというゲームだ．
    近所の子と一緒に熱中した懐かしい思い出が蘇り，
    掃除の途中であるのだが久しぶりに1回だけ遊ぶことにした．
  </p>

  <p>
    このおもちゃの概観を図7に示す．
  </p>

  <div class="figure">
    <table>
      <tbody>
	<tr>
	  <td>
	    <img src="img/toy.1.png"
		 alt="チクチクバンバンの概観図．">
	  </td>
	</tr>
	<tr>
	  <td>図7: チクチクバンバンの概観図．</td>
	</tr>
      </tbody>
    </table>
  </div>

  <p>
    このおもちゃは，1枚のフレーム，
    <var>W</var>&times;<var>H</var>−1 枚のタイル，1台の列車でできている．
    フレームには横幅 <var>W</var>，縦幅 <var>H</var>
    の長方形の窪みが空いていて，
    その窪みと隣接するように駅が2つ描かれている．
    タイルは 1&times;1 の大きさで上面にレールが彫ってあり，
    フレームの窪みにはめるとちょうど 1&times;1
    の大きさの隙間が残るようになっている．
    この隙間と上下左右に隣接するタイルをスライドさせ，
    タイルと隙間の位置を入れ替えることによって，
    タイルの配置を変更することができるようになっている．
  </p>

  <p>
    ゲームスタート時には，片方の駅に列車が置かれている
    （図7では列車を三角の印で表現している）．
    ゲームスタートと同時に列車は駅を出発し，
    レールに沿って移動し続ける．
    タイルの上のレールの形に関わらず，
    列車はあるタイルに入ってから出てくるまでにちょうど時間 1 を費やす．
    プレイヤーはタイルを適切なタイミングでスライドさせ，
    列車を脱線させないようにしなくてはいけない．
    脱線とは，レールが繋がっていない方向からタイルへ進入したり，
    タイルとタイルの隙間に落ちたり，
    駅以外のフレームに乗り上げたりすることである．
    列車がスタートした方とは異なる駅に到着することができたらゲームクリアである．
  </p>

  <p>
    私はこのゲームをさんざんプレイしたことがあるため，
    タイルはいつでも好きな時に滑らかに，
    列車の速度に対して無視できる時間で動かすことができる．
    また，列車が乗っているタイルを列車ごとスライドさせるという
    高等テクニックも身につけている．
    そのため，慣れた手つきで格好良く軽々とクリアできるはずであった．
    ところが，長い間蒸し暑い屋根裏部屋に置いていたせいか，
    プラスチックが溶けてフレームとくっついてしまい，
    いくつかのタイルが動かなくなっていることがわかった．
    そのため，ゲームが非常に難しく，そしてより魅力的になってしまっていた．
    何度もプレイした結果，タイルの配置によっては
    クリアできるかどうかすら簡単にわからないこともあるということがわかった．
  </p>

  <p>
    ここであなたにお願いがある．
    ゲームの初期盤面を与えると，
    その盤面がクリア可能かどうかを判定し，
    クリア可能なら列車の最短移動時間を求めるプログラムを書いて欲しい．
    もしプログラムが完成したなら，
    きっと私はこのゲームから足を洗うことができ，
    掃除の続きに戻ることができるだろうから．
  </p>

  <h2>Input</h2>
  <p>
    入力は複数のデータセットからなり，
    1行目にデータセット数が与えられる．
    以降に，それぞれのデータセットが続く．
  </p>

  <p>
    それぞれのデータセットは以下のようなフォーマットで与えられる．
  </p>

  <div class="illust">
    <var>W</var> <var>H</var><br>
    <var>P</var><sub>0</sub> <var>T</var><sub>0</sub>
    <var>P</var><sub>1</sub> <var>T</var><sub>1</sub><br>
    <var>L</var><sub>0</sub><br>
    <var>L</var><sub>1</sub><br>
    ...<br>
    <var>L</var><sub><var>H</var>−1</sub>
  </div>

  <p>
    ただし，記号の意味は以下の通りである：
  </p>

  <ul>
    <li>
      <var>W</var>, <var>H</var> はそれぞれ箱の横幅・縦幅を表し，
      1 &le; <var>W</var>, <var>H</var> &le; 20 を満たす．
    </li>
    <li>
      (<var>P</var><sub>0</sub>, <var>T</var><sub>0</sub>) と
      (<var>P</var><sub>1</sub>, <var>T</var><sub>1</sub>)
      はそれぞれ異なる2箇所の駅の位置を表す．
      <var>P</var> は 0, 1, 2, 3 のいずれかの値をもち，
      それぞれ駅がフレームの上辺・右辺・下辺・左辺に存在していることを意味する．
      <var>T</var> は <var>P</var> の値によってそれぞれ次のような意味を持つ：
      <ul>
	<li>
	  <var>P</var> = 0, 2 のとき，左からいくつの位置に駅があるかを表し，
	  0 &le; <var>T</var> &le; <var>W</var>−1 を満たす．
	</li>
	<li>
	  <var>P</var> = 1, 3 のとき，上からいくつの位置に駅があるかを表し，
	  0 &le; <var>T</var> &le; <var>H</var>−1 を満たす．
	</li>
      </ul>
    </li>
    <li>
      <var>L</var><sub>0</sub>, ..., <var>L</var><sub><var>H</var>−1</sub>
      はそれぞれ長さ <var>W</var> の文字列であり，
      各文字は1つのタイルを意味し，
      全体で初期盤面の配置がどのようになっているかを表している．
      タイルにはそれぞれ図8のように名前がつけられており，
      動くタイルは名前が大文字で，動かないタイルは名前が小文字で与えられる．
      ここで，タイル D は，上下左右から列車が進入でき，
      進入してきた列車が直進してそのまま抜けていくタイルであり，
      また，
      E, F, G, H のタイルは，
      ある一方から来た列車が輪を描くように動き，
      同じ方向から出て行くというタイルである．
      初めの隙間の位置は &ldquo;<code>#</code>&rdquo; で与えられる．
    </li>
  </ul>

  <div class="figure">
    <table>
      <tbody>
	<tr>
	  <td>
	    <img src="img/toy.2.png"
		 alt="タイルの種類．">
	  </td>
	</tr>
	<tr>
	  <td>図8: タイルの種類．</td>
	</tr>
      </tbody>
    </table>
  </div>

  <h2>Output</h2>
  <p>
    データセットごとに，
    列車が駅間を移動するのに最低限必要となる時間を1行に1つ出力せよ．
    もし駅間の移動が不可能なら &ldquo;<code>-1</code>&rdquo; を出力せよ．
  </p>

  <h2>Sample Input</h2>
  <pre class="sampleinput">2
4 3
1 2 3 0
#bJG
KBBB
EeEA
6 5
3 4 1 2
aaaIMM
aaaIaA
N#BJDA
DaBaaa
MNBaaa</pre>

  <h2>Output for the Sample Input</h2>
  <pre class="sampleoutput">6
-1</pre>

  <p>
    サンプル入力の最初のデータセットの解決法を以下に示す．
    以下の説明において， <var>t</var>
    は列車がタイルに乗った瞬間からの時間を表す．
    図9において，
    列車は白い三角形の印で表し，
    固着したタイルはグレーで表している．
  </p>

  <div class="figure">
    <table>
      <tbody>
	<tr>
	  <td>
	    <img src="img/toy.3.png"
		 alt="サンプル入力の最初のデータセットの解決法．">
	  </td>
	</tr>
	<tr>
	  <td>図9: サンプル入力の最初のデータセットの解決法．</td>
	</tr>
      </tbody>
    </table>
  </div>

  <ol>
    <li>
      左側にある駅からスタートする（図9 (a)）．
    </li>
    <li>
      <var>t</var> = 0:
      タイルを上・左と移動させる（図9 (b)）．
    </li>
    <li>
      <var>t</var> = 0 – 1.5:
      列車を出発させ，時間が 1.5 経過する（図9 (c)）．
    </li>
    <li>
      <var>t</var> = 1.5 – 2.5:
      タイルを右に移動し，時間が 1 経過する（図9 (d)）．
    </li>
    <li>
      <var>t</var> = 2.5 – 3.5:
      タイルを左・左・下・左・上と移動し，時間が 1 経過する（図9 (e)）．
    </li>
    <li>
      <var>t</var> = 3.5 – 4.5:
      タイルを右・右と移動し，時間が 1 経過する（図9 (f)）．
    </li>
    <li>
      <var>t</var> = 4.5 – 5.5:
      タイルを左・左と移動し，時間が 1 経過する（図9 (g)）．
    </li>
    <li>
      <var>t</var> = 5.5 – 6:
      タイルを右・上・左・下と移動し，時間が 0.5 経過する（図9 (h)）．
    </li>
  </ol>

  <hr>
  <address>
    東京大学プログラミングコンテスト2008<br>
    Problemsetter: Yusuke Konishi
  </address>
</html>
