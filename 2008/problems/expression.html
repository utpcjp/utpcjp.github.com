<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">

<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>Problem J: いにしえの数式</title>
    <style type="text/css">
      <!--
      h1 {
        text-align: center;
      }

      .timelimit {
        font-weight: bold;
	text-align: right;
      }

      .figure {
        text-align: center;
      }

      .figure table {
        margin-left: auto;
	margin-right: auto;
      }

      pre.sampleinput, pre.sampleoutput {
	padding: 0.5em;
        border: solid thin black;
      }

      .illust {
        margin-left: 3em;
	margin-right: 3em;
      }

      #DEFINITION .bar-cell {
        text-align: right;
      }

      -->
    </style>
  </head>
  <h1>Problem J: いにしえの数式</h1>
  <p class="timelimit">Time Limit: 5 sec</p>

  <p>
    あなたの友人の考古学者が遺跡を発掘していた．
    ある日，彼は怪しげな記号の羅列が刻まれている石盤を大量に発見した．
    彼はこの大発見に大喜びし，すぐさま石盤に刻まれている記号の解読を始めた．
    何週間にもわたる彼の解読の努力の結果，
    どうやらこれらの石盤には変数・演算子・カッコの組み合わせで成り立っている
    数式のようなものが刻まれていることがわかった．
    発掘した石盤と遺跡に関わる文献を調べていくうちに彼はさらに，
    それぞれの石盤で演算子の結合規則が異なっており，
    それぞれの石盤の先頭に演算子の結合規則が記されているらしいことを突きとめた．
    しかし，彼は数学が苦手であるため，演算子の結合規則を見ても
    すぐには数式がどのように結合しているかがわからなかった．
    そこで彼は，優れたコンピュータサイエンティストであるあなたに
    「石盤に書かれている数式がどのように結合しているかを調べてほしい」
    と依頼してきた．
    あなたは，彼を手助けすることができるだろうか？
  </p>

  <p>
    数式中に現れる演算子には優先順位が定められており，
    優先順位の高い演算子から順に結合していく．
    同一優先順位をもつ演算子にはそれぞれ結合方向が定められており，
    左から右に結合する場合は左にある演算子から順に，
    右から左に結合する場合は右にある演算子から順に結合していく．
    例えば， <code>+</code> より <code>*</code> の方が優先順位が高く，
    <code>*</code> が左から右に結合する場合，
    式 <code>a+b*c*d</code> は <code>(a+((b*c)*d))</code> のように結合する．
    サンプル入力にも他の例がいくつか挙げられているので参照のこと．
  </p>

  <h2>Input</h2>
  <p>
    入力に与えられる数式は，以下の <var>Expr</var>
    で定義されるような文字列である．
    この定義において，<var>Var</var> は変数を表し，
    <var>Op</var> は演算子を表す．
  </p>

  <div class="illust">
    <table id="DEFINITION">
      <tbody>
	<tr>
	  <td><var>Expr</var></td>
	  <td>::=</td>
	  <td><var>Var</var></td>
	</tr>
	<tr>
	  <td></td>
	  <td class="bar-cell">|</td>
	  <td><var>Expr</var> <var>Op</var> <var>Expr</var></td>
	</tr>
	<tr>
	  <td></td>
	  <td class="bar-cell">|</td>
	  <td>
	    &ldquo;<code>(</code>&rdquo;
	    <var>Expr</var>
	    &ldquo;<code>)</code>&rdquo;
	  </td>
	</tr>
	<tr>
	  <td><var>Var</var></td>
	  <td>::=</td>
	  <td>
	    &ldquo;<code>a</code>&rdquo; |
	    &ldquo;<code>b</code>&rdquo; |
	    ... |
	    &ldquo;<code>z</code>&rdquo;
	  </td>
	</tr>
	<tr>
	  <td><var>Op</var></td>
	  <td>::=</td>
	  <td>
	    &ldquo;<code>+</code>&rdquo; |
	    &ldquo;<code>-</code>&rdquo; |
	    &ldquo;<code>*</code>&rdquo; |
	    &ldquo;<code>/</code>&rdquo; |
	    &ldquo;<code>&lt;</code>&rdquo; |
	    &ldquo;<code>&gt;</code>&rdquo; |
	    &ldquo;<code>=</code>&rdquo; |
	    &ldquo;<code>&amp;</code>&rdquo; |
	    &ldquo;<code>|</code>&rdquo; |
	    &ldquo;<code>^</code>&rdquo;
	  </td>
	</tr>
      </tbody>
    </table>
  </div>

  <p>
    演算子はすべて二項演算子であり，単項演算子やその他の演算子は存在しない．
  </p>

  <p>
    入力は，いくつかのデータセットからなる．
    入力の先頭行にデータセット数 <var>D</var> (<var>D</var> &le; 100)
    が与えられ，
    以降の行に <var>D</var> 個のデータセットが続く．
  </p>

  <p>
    それぞれのデータセットは，次のようなフォーマットで与えられる．
  </p>

  <div class="illust">
    （演算子の結合規則の定義）<br>
    （クエリの定義）
  </div>

  <p>
    演算子の結合規則の定義は，以下のようなフォーマットで与えられる．この定義において，<var>G</var> は演算子グループの数を表す数である．
  </p>

  <div class="illust">
    <var>G</var><br>
    （演算子グループ1 の定義）<br>
    （演算子グループ2 の定義）<br>
    ...<br>
    （演算子グループ<var>G</var> の定義）
  </div>

  <p>
    演算子は，結合の優先順位ごとにグループに分けられている．
    同一のグループに属する演算子は結合の優先順位が等しく，
    グループの定義が後に現れる演算子の方が
    前に現れる演算子より結合の優先順位が高い．
  </p>

  <p>
    それぞれの演算子グループは，以下のように定義される．
  </p>

  <div class="illust">
    <var>A</var> <var>M</var> <var>p</var><sub>1</sub>
    <var>p</var><sub>2</sub> ... <var>p</var><sub><var>M</var></sub>
  </div>

  <p>
    <var>A</var> は演算子の結合方向を表す文字で，
    &ldquo;<code>L</code>&rdquo; か &ldquo;<code>R</code>&rdquo; の
    いずれかである．
    &ldquo;<code>L</code>&rdquo; は左から右に結合することを表し，
    &ldquo;<code>R</code>&rdquo; は右から左に結合することを表す．
    <var>M</var> (<var>M</var> &gt; 0)
    は演算子グループに含まれる演算子の数であり，
    <var>p</var><sub><var>i</var></sub> (1 &le; <var>i</var> &le; <var>M</var>)
    はグループに含まれる演算子を表す文字である．
    同じ演算子がグループ内に2度現れることはなく，また，
    データセット内にグループをまたがって
    同じ演算子が2度現れることもない．
  </p>

  <p>
    演算子の定義には，上記の <var>Op</var> で定義された演算子のみが現れる．
    1つのデータセットにおいて，必ず1つ以上の演算子が定義されると仮定してよい．
  </p>

  <p>
    クエリの定義は以下のようなフォーマットで与えられる．
  </p>

  <div class="illust">
    <var>N</var><br>
    <var>e</var><sub>1</sub><br>
    <var>e</var><sub>2</sub><br>
    ...<br>
    <var>e</var><sub><var>N</var></sub>
  </div>

  <p>
    <var>N</var> (0 &lt; <var>N</var> &le; 50) はクエリとして与えられる
    数式の数である．
    <var>e</var><sub><var>i</var></sub>
    (1 &le; <var>i</var> &le; <var>N</var>)
    は上記の <var>Expr</var> の定義を満たすような
    式を表す空でない文字列である．
    <var>e</var><sub><var>i</var></sub> の長さはたかだか100文字であり，
    当該データセットで定義されていない演算子は出現しないものと仮定してよい．
  </p>

  <h2>Output</h2>
  <p>
    データセットごとに，
    クエリとして与えられたそれぞれの式について，
    式中の各演算子について必ず1つのカッコの組を用いて
    すべての二項演算を正しく囲み，
    演算子の結合を表現した文字列を出力せよ．
    入力の式に現れる変数や演算子の順序を変更してはならない．
  </p>

  <p>
    それぞれのデータセットの間には空行を出力せよ．
    出力の末尾に空行を出力してはならない．
  </p>

  <h2>Sample Input</h2>
  <pre class="sampleinput">2
3
R 1 =
L 2 + -
L 2 * /
6
a+b*c-d
(p-q)/q/d
a+b*c=d-e
t+t+t+t+t
s=s=s=s=s
(((((z)))))
3
R 3 = &lt; &gt;
L 3 & | ^
L 4 + - * /
1
a&gt;b*c=d&lt;e|f+g^h&amp;i&lt;j&gt;k</pre>

  <h2>Output for the Sample Input</h2>
  <pre class="sampleoutput">((a+(b*c))-d)
(((p-q)/q)/d)
((a+(b*c))=(d-e))
((((t+t)+t)+t)+t)
(s=(s=(s=(s=s))))
z

(a&gt;((b*c)=(d&lt;((((e|(f+g))^h)&amp;i)&lt;(j&gt;k)))))</pre>

  <hr>
  <address>
    東京大学プログラミングコンテスト2008<br>
    Problemsetter: Yuta Kitamura
  </address>
</html>
